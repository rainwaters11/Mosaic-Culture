{% extends "base.html" %}

{% block title %}Story Gallery{% endblock %}

{% block content %}
<div class="gallery-header mb-4">
    <h1 class="text-center">Story Gallery</h1>
    <div class="filters text-center mb-4">
        <div class="btn-group mb-3" role="group">
            <a href="{{ url_for('gallery') }}" class="btn btn-outline-primary">All Regions</a>
            <a href="{{ url_for('gallery', region='Asia') }}" class="btn btn-outline-primary">Asia</a>
            <a href="{{ url_for('gallery', region='Africa') }}" class="btn btn-outline-primary">Africa</a>
            <a href="{{ url_for('gallery', region='Europe') }}" class="btn btn-outline-primary">Europe</a>
            <a href="{{ url_for('gallery', region='Americas') }}" class="btn btn-outline-primary">Americas</a>
        </div>

        {% if all_tags %}
        <div class="tags-filter mb-3">
            <div class="d-flex flex-wrap justify-content-center gap-2">
                <a href="{{ url_for('gallery') }}" class="btn btn-sm btn-outline-secondary">All Tags</a>
                {% for tag in all_tags %}
                <a href="{{ url_for('gallery', tag=tag.name) }}" 
                   class="btn btn-sm btn-outline-secondary">
                    #{{ tag.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    {% for story in stories %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 fade-in">
            {% if story.media_url %}
            <img src="{{ story.media_url }}" class="card-img-top" alt="{{ story.title }}">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ story.title }}</h5>
                <p class="card-text">{{ story.content[:200] }}...</p>
                <div class="story-meta">
                    <span class="badge bg-secondary">{{ story.region }}</span>
                    <small class="text-muted d-block mt-2">
                        By {{ story.author.username }}
                        {% if story.submission_date %}
                            on {{ story.submission_date.strftime('%B %d, %Y') }}
                        {% endif %}
                    </small>
                </div>

                {% if story.tags %}
                <div class="story-tags mt-3">
                    {% for tag in story.tags %}
                    <a href="{{ url_for('gallery', tag=tag.name) }}" 
                       class="badge bg-light text-dark text-decoration-none">
                        #{{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="interactions mt-3">
                    {% if current_user.is_authenticated %}
                    <button class="btn btn-sm btn-outline-primary like-btn" data-story-id="{{ story.id }}">
                        <i class="fas fa-heart"></i> 
                        <span class="like-count">{{ story.likes|length }}</span>
                    </button>
                    {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-heart"></i> 
                        <span class="like-count">{{ story.likes|length }}</span>
                    </a>
                    {% endif %}

                    <button class="btn btn-sm btn-outline-secondary" onclick="shareStory({{ story.id }}, '{{ story.title }}')">
                        <i class="fas fa-share-alt"></i> Share
                    </button>

                    <a href="{{ url_for('view_story', story_id=story.id) }}" 
                       class="btn btn-sm btn-outline-primary">
                        Read More
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Share Story Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Story</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="share-buttons">
                    <button class="btn btn-outline-info w-100 mb-2" 
                            onclick="shareOn('twitter')">
                        <i class="fab fa-twitter me-2"></i>Share on Twitter
                    </button>
                    <button class="btn btn-outline-primary w-100 mb-2" 
                            onclick="shareOn('facebook')">
                        <i class="fab fa-facebook me-2"></i>Share on Facebook
                    </button>
                    <button class="btn btn-outline-secondary w-100" 
                            onclick="shareOn('linkedin')">
                        <i class="fab fa-linkedin me-2"></i>Share on LinkedIn
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStoryId = null;
let currentStoryTitle = '';

function shareStory(storyId, storyTitle) {
    currentStoryId = storyId;
    currentStoryTitle = storyTitle;
    var shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    shareModal.show();
}

function shareOn(platform) {
    const title = currentStoryTitle;
    const url = `${window.location.origin}/story/${currentStoryId}`;

    let shareUrl;
    switch(platform) {
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`;
            break;
        case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            break;
        case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
            break;
    }

    window.open(shareUrl, '_blank', 'width=600,height=400');
}
</script>
{% endblock %}