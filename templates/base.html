<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosaic Culture - {% block title %}{% endblock %}</title>

    <!-- Social Media Meta Tags -->
    <meta property="og:site_name" content="Mosaic Culture">
    <meta property="og:title" content="{% block og_title %}Mosaic Culture{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Discover and share cultural stories from around the world{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ url_for('static', filename='images/default-share.jpg', _external=True) }}{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{{ request.url }}">

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ self.og_title() }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ self.og_description() }}{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{{ self.og_image() }}{% endblock %}">

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Load Facebook SDK for JavaScript -->
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" 
            src="https://connect.facebook.net/en_US/sdk.js#version=v18.0">
    </script>

    <!-- Loading Spinner Overlay -->
    <div class="spinner-overlay" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Mosaic Culture" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('gallery') }}">Gallery</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('submit_story') }}">Submit Story</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <span class="nav-link">Welcome, {{ current_user.username }}!</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('profile') }}">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('register') }}">Register</a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <button class="theme-toggle nav-link" id="theme-toggle" aria-label="Toggle theme">
                            <i class="fas fa-sun" id="theme-icon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} fade-in">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Floating Action Button with tooltip -->
    {% if not request.endpoint == 'submit_story' %}
    <a href="{{ url_for('submit_story') }}" 
       class="fab" 
       aria-label="Submit Story"
       data-tooltip="Share your cultural story">
        <i class="fas fa-plus"></i>
    </a>
    {% endif %}

    <footer class="footer mt-5 py-3">
        <div class="container text-center">
            <p>&copy; 2024 Mosaic Culture. All rights reserved.</p>
        </div>
    </footer>

    <!-- Story Preview Modal -->
    <div class="modal story-preview-modal fade" id="storyPreviewModal" tabindex="-1" aria-labelledby="storyPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="story-preview-content">
                        <div class="story-preview-image">
                            <img src="" alt="" class="w-100">
                        </div>
                        <div class="story-preview-details p-4">
                            <h3 class="story-preview-title"></h3>
                            <div class="story-preview-meta mb-3">
                                <span class="badge bg-secondary region-badge"></span>
                                <small class="text-muted author-info"></small>
                            </div>
                            <div class="story-preview-tags mb-3"></div>
                            <div class="story-preview-text mb-4"></div>
                            <div class="story-preview-footer">
                                <a href="" class="btn btn-primary read-more-btn">Read Full Story</a>
                                <div class="engagement-stats mt-3">
                                    <span class="likes me-3">
                                        <i class="fas fa-heart text-danger"></i> 
                                        <span class="likes-count">0</span>
                                    </span>
                                    <span class="comments">
                                        <i class="fas fa-comment"></i> 
                                        <span class="comments-count">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        // Theme toggling functionality
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const html = document.documentElement;

            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            themeToggle.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            function updateThemeIcon(theme) {
                themeIcon.className = theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
            }
        });

        // Initialize Feather icons
        feather.replace();

        // Social Media Sharing
        function shareStory(platform, url, title, description) {
            if (navigator.share && platform === 'native') {
                navigator.share({
                    title: title,
                    text: description,
                    url: url
                })
                .then(() => console.log('Successful share'))
                .catch((error) => console.log('Error sharing:', error));
                return false;
            }

            const shareUrls = {
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`
            };

            window.open(shareUrls[platform], '_blank', 'width=600,height=400');
            return false;
        }

        // Initialize Facebook SDK
        window.fbAsyncInit = function() {
            FB.init({
                appId: '{{ config.get("FACEBOOK_APP_ID", "") }}',
                xfbml: true,
                version: 'v18.0'
            });
        };

        // Add animation classes to elements when they enter viewport
        document.addEventListener('DOMContentLoaded', () => {
            const animateOnScroll = (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                        observer.unobserve(entry.target);
                    }
                });
            };

            const observer = new IntersectionObserver(animateOnScroll, {
                threshold: 0.1
            });

            // Observe all cards and sections for animation
            document.querySelectorAll('.card, .hero-section').forEach(el => {
                el.classList.remove('fade-in');  
                observer.observe(el);
            });
        });

        // Loading Spinner Functions
        const loadingSpinner = {
            show: function() {
                document.getElementById('loadingSpinner').classList.add('active');
            },
            hide: function() {
                document.getElementById('loadingSpinner').classList.remove('active');
            }
        };

        // Show loading spinner during form submissions
        document.addEventListener('submit', function(e) {
            if (e.target.tagName === 'FORM') {
                loadingSpinner.show();
            }
        });

        // Show loading spinner during navigation (except for same-page anchors)
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && !link.getAttribute('href').startsWith('#') && !link.getAttribute('href').startsWith('javascript:')) {
                loadingSpinner.show();
            }
        });

        // Hide loading spinner when page is fully loaded
        window.addEventListener('load', function() {
            loadingSpinner.hide();
        });

        // Story Preview Modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            const previewModal = document.getElementById('storyPreviewModal');
            if (previewModal) {
                const modal = new bootstrap.Modal(previewModal);

                document.querySelectorAll('.story-preview-trigger').forEach(trigger => {
                    trigger.addEventListener('click', function(e) {
                        e.preventDefault();
                        const storyData = this.dataset;

                        // Update modal content
                        const modalContent = previewModal.querySelector('.story-preview-content');
                        modalContent.querySelector('.story-preview-image img').src = storyData.image || '';
                        modalContent.querySelector('.story-preview-image img').alt = storyData.title;
                        modalContent.querySelector('.story-preview-title').textContent = storyData.title;
                        modalContent.querySelector('.region-badge').textContent = storyData.region;
                        modalContent.querySelector('.author-info').textContent = storyData.author;
                        modalContent.querySelector('.story-preview-text').textContent = storyData.excerpt;
                        modalContent.querySelector('.read-more-btn').href = storyData.url;
                        modalContent.querySelector('.likes-count').textContent = storyData.likes;
                        modalContent.querySelector('.comments-count').textContent = storyData.comments;

                        // Handle tags
                        const tagsContainer = modalContent.querySelector('.story-preview-tags');
                        tagsContainer.innerHTML = '';
                        if (storyData.tags) {
                            const tags = JSON.parse(storyData.tags);
                            tags.forEach(tag => {
                                const tagElement = document.createElement('a');
                                tagElement.href = `/gallery?tag=${tag}`;
                                tagElement.className = 'badge bg-light text-dark text-decoration-none me-1';
                                tagElement.textContent = `#${tag}`;
                                tagsContainer.appendChild(tagElement);
                            });
                        }

                        modal.show();
                    });
                });
            }
        });
    </script>
</body>
</html>