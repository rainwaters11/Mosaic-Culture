{% extends "base.html" %}

{% block title %}Submit Story{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="text-center mb-0">Share Your Story</h2>
            </div>
            <div class="card-body">
                <form action="{{ url_for('submit_story') }}" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Story Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="theme" class="form-label">Theme</label>
                        <select class="form-select" id="theme" name="theme" required>
                            <option value="">Select a theme</option>
                            <option value="Traditions">Traditions & Customs</option>
                            <option value="Festivals">Festivals & Celebrations</option>
                            <option value="Food">Food & Cuisine</option>
                            <option value="Art">Art & Crafts</option>
                            <option value="Music">Music & Dance</option>
                            <option value="Folklore">Folklore & Mythology</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="region" class="form-label">Region</label>
                        <select class="form-select" id="region" name="region" required>
                            <option value="">Select a region</option>
                            <option value="Asia">Asia</option>
                            <option value="Africa">Africa</option>
                            <option value="Europe">Europe</option>
                            <option value="Americas">Americas</option>
                            <option value="Oceania">Oceania</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="use_ai" name="use_ai">
                            <label class="form-check-label" for="use_ai">
                                Use AI to Help Generate Story
                            </label>
                            <small class="form-text text-muted d-block">AI will create a story based on your title, theme, and region</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">Your Story</label>
                        <textarea class="form-control" id="content" name="content" rows="6" required></textarea>
                        <small class="form-text text-muted">Share your story or edit the AI-generated content</small>
                    </div>

                    <div class="mb-3">
                        <label for="tags" class="form-label">Cultural Tags</label>
                        <div class="tag-input-container">
                            <input type="text" class="form-control" id="tags" name="tags" 
                                   placeholder="Enter tags separated by commas">
                            <div id="tagSuggestions" class="mt-2">
                                <small class="text-muted">Suggested cultural tags will appear here</small>
                            </div>
                        </div>
                        <small class="form-text text-muted">Add relevant cultural tags to help others find your story</small>
                    </div>

                    <div class="mb-3">
                        <label for="media" class="form-label">Upload Media (Optional)</label>
                        <input type="file" class="form-control" id="media" name="media" accept="image/*,video/*,audio/*">
                        <small class="form-text text-muted">Support images, videos, and audio files</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="generate_image" name="generate_image">
                            <label class="form-check-label" for="generate_image">
                                Generate AI Illustration
                            </label>
                            <small class="form-text text-muted d-block">Creates an AI-generated image based on your story</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="generate_audio" name="generate_audio">
                            <label class="form-check-label" for="generate_audio">
                                Generate Audio Narration
                            </label>
                            <small class="form-text text-muted d-block">Uses AI to create an audio version of your story</small>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">Submit Story</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const useAiCheckbox = document.getElementById('use_ai');
    const contentTextarea = document.getElementById('content');
    const submitButton = document.querySelector('button[type="submit"]');
    const form = document.querySelector('form');
    const regionSelect = document.getElementById('region');
    const tagInput = document.getElementById('tags');
    const tagSuggestions = document.getElementById('tagSuggestions');
    const generateImageCheckbox = document.getElementById('generate_image');
    const generateAudioCheckbox = document.getElementById('generate_audio');

    // Add loading overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-none';
    loadingOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
    loadingOverlay.style.zIndex = '1000';
    loadingOverlay.innerHTML = `
        <div class="position-absolute top-50 start-50 translate-middle text-white text-center">
            <div class="spinner-border mb-2" role="status"></div>
            <div id="loading-text">Processing...</div>
        </div>
    `;
    document.body.appendChild(loadingOverlay);

    const showLoading = (message) => {
        document.getElementById('loading-text').textContent = message;
        loadingOverlay.classList.remove('d-none');
    };

    const hideLoading = () => {
        loadingOverlay.classList.add('d-none');
    };

    // Debounce function for tag suggestions
    const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };

    // Tag suggestion logic with debouncing
    const getSuggestions = debounce(async () => {
        const content = contentTextarea.value;
        const region = regionSelect.value;

        if (!content || !region) return;

        try {
            showLoading('Getting tag suggestions...');
            const response = await fetch('/api/suggest_tags', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content, region })
            });

            const data = await response.json();
            if (data.success && data.tags) {
                const suggestions = data.tags
                    .filter(tag => !tagInput.value.includes(tag))
                    .map(tag => `
                        <span class="badge bg-secondary me-1 mb-1 suggested-tag" 
                              style="cursor: pointer;">${tag}</span>
                    `)
                    .join('');

                tagSuggestions.innerHTML = suggestions ? 
                    `<small class="text-muted d-block mb-2">Suggested cultural tags:</small>${suggestions}` :
                    '<small class="text-muted">No additional suggestions</small>';

                document.querySelectorAll('.suggested-tag').forEach(tag => {
                    tag.addEventListener('click', () => {
                        const currentTags = tagInput.value.split(',').map(t => t.trim()).filter(t => t);
                        currentTags.push(tag.textContent.trim());
                        tagInput.value = currentTags.join(', ');
                        tag.remove();
                    });
                });
            }
        } catch (error) {
            console.error('Error getting tag suggestions:', error);
            tagSuggestions.innerHTML = '<small class="text-danger">Error getting suggestions. Please try again.</small>';
        } finally {
            hideLoading();
        }
    }, 1000);

    contentTextarea.addEventListener('input', getSuggestions);
    regionSelect.addEventListener('change', getSuggestions);

    // Enhanced story generation with better feedback
    useAiCheckbox.addEventListener('change', async function() {
        if (this.checked) {
            const title = document.getElementById('title').value;
            const theme = document.getElementById('theme').value;
            const region = document.getElementById('region').value;

            if (!title || !theme || !region) {
                alert('Please fill in the title, theme, and region before using AI generation.');
                this.checked = false;
                return;
            }

            try {
                showLoading('Generating your story...');
                submitButton.disabled = true;

                const response = await fetch('/generate_story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, theme, region })
                });

                const data = await response.json();
                if (data.success && data.content) {
                    contentTextarea.value = data.content;

                    // Show sensitivity feedback if available
                    if (data.sensitivity) {
                        const sensitivityHtml = `
                            <div class="alert alert-info mt-3">
                                <h6>Cultural Sensitivity Analysis:</h6>
                                <p>Rating: ${data.sensitivity.rating}/10</p>
                                ${data.sensitivity.suggestions ? 
                                    `<p><strong>Suggestions:</strong> ${data.sensitivity.suggestions}</p>` : ''}
                            </div>
                        `;
                        contentTextarea.insertAdjacentHTML('afterend', sensitivityHtml);
                    }
                } else {
                    throw new Error(data.error || 'Failed to generate story');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while generating the story. Please try again or write your story manually.');
                this.checked = false;
            } finally {
                submitButton.disabled = false;
                hideLoading();
            }
        }
    });

    // Form submission handling
    form.addEventListener('submit', async (e) => {
        if (generateImageCheckbox.checked || generateAudioCheckbox.checked) {
            e.preventDefault();
            showLoading('Submitting story and generating media...');

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting your story. Please try again.');
                hideLoading();
            }
        }
    });
});
</script>

<style>
.suggested-tag:hover {
    background-color: #6c757d !important;
    opacity: 0.9;
}
</style>
{% endblock %}